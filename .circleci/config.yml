# Generated from CircleCI.pkl. DO NOT EDIT.
version: '2.1'
orbs:
  pr-approval: apple/pr-approval@0.1.0
jobs:
  build:
    steps:
    - checkout
    - run:
        command: ./gradlew --info --stacktrace -DtestReportsDir="${HOME}/test-results" check
    - persist_to_workspace:
        root: '.'
        paths:
        - build/libs/
    - store_test_results:
        path: ~/test-results
    docker:
    - image: cimg/openjdk:21.0
  build-release:
    steps:
    - checkout
    - run:
        command: ./gradlew --info --stacktrace -DtestReportsDir="${HOME}/test-results" -DreleaseBuild=true check
    - persist_to_workspace:
        root: '.'
        paths:
        - build/libs/
    - store_test_results:
        path: ~/test-results
    docker:
    - image: cimg/openjdk:21.0
  test-linux:
    steps:
    - checkout
    - attach_workspace:
        at: '.'
    - run:
        command: ./gradlew --info --stacktrace verifyDistribution
    docker:
    - image: cimg/openjdk:21.0
  test-macos:
    steps:
    - checkout
    - attach_workspace:
        at: '.'
    - run:
        command: ./gradlew --info --stacktrace verifyDistribution
    resource_class: macos.m1.large.gen1
    macos:
      xcode: 15.3.0
  test-windows:
    shell: bash.exe
    steps:
    - checkout
    - attach_workspace:
        at: '.'
    - run:
        command: ./gradlew --info --stacktrace verifyDistribution
    resource_class: windows.large
    machine:
      image: windows-server-2022-gui:current
  do-release:
    steps:
    - attach_workspace:
        at: '.'
    - run:
        command: echo "release"
        name: gh release
    docker:
    - image: maniator/gh:v2.40.1
workflows:
  prb:
    jobs:
    - hold:
        type: approval
    - pr-approval/authenticate:
        context: pkl-pr-approval
    - build:
        requires:
        - hold
    - test-linux:
        requires:
        - build
        - hold
    - test-macos:
        requires:
        - build
        - hold
    - test-windows:
        requires:
        - build
        - hold
    when:
      matches:
        value: << pipeline.git.branch >>
        pattern: ^pull/\d+(/head)?$
  main:
    jobs:
    - build
    - test-linux:
        requires:
        - build
    - test-macos:
        requires:
        - build
    - test-windows:
        requires:
        - build
    when:
      equal:
      - main
      - << pipeline.git.branch >>
  ci-setup:
    jobs:
    - build:
        requires:
        - approval
    - test-linux:
        requires:
        - build
    - test-macos:
        requires:
        - build
    - test-windows:
        requires:
        - build
    when:
      equal:
      - << pipeline.git.branch >>
      - main
