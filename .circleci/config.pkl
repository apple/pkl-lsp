amends "package://pkg.pkl-lang.org/pkl-project-commons/pkl.impl.circleci@1.1.1#/PklCI.pkl"

prb = buildWorkflow

main = buildWorkflow

jobs {
  ["build"] {
    docker {
      new {
        image = "cimg/openjdk:21.0-node"
      }
    }
    steps {
      "checkout"
      new RunStep {
        command = "git submodule update --init --recursive"
      }
      new RunStep {
        command = """
          LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:." ./gradlew --info --stacktrace -DtestReportsDir="${HOME}/test-results" generateTreeSitterLib check
          """
      }
      new StoreTestResults { path = "~/test-results" }
    }
  }
  ["do-release"] {
    docker {
      new { image = "maniator/gh:v2.40.1" }
    }
    steps {
      new AttachWorkspaceStep {
        at = "."
      }
      new RunStep {
        name = "gh release"
        command = """
          echo "release"
          """
      }
    }
  }
}

local buildWorkflow = new Workflow {
  jobs {
    "build"
  }
}